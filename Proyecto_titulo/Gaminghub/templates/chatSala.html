<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

<link rel="stylesheet" href="{% static 'css/chatsala.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container chat">
        <div style="text-align: center;">
            <h2 class="fuente">{{ sala.fk_id_grupo.titulo }}</h2>
            <h5 class="fuente">( {{ sala.nombre_sala }} )</h5>
        </div>
        
        <div class="chat-messages" style="max-width: 100%; margin: 0 auto;">
            {% for chat in chat %}
            <p>{{ chat.remitente }}</p>
            <p>{{ chat.contenido }}</p>
            {% endfor %}
        </div>
        
        <!-- Aquí puedes agregar el formulario para enviar nuevos mensajes -->
        <form method="post" action="{% url 'enviarMensajeGrupo' sala_id=sala.id_sala %}" style="text-align: center;">
            {% csrf_token %}
            <textarea id="textAreaExample3" type="text" class="form-control" name="mensaje" placeholder="Escribe tu mensaje..." cols="2" rows="2" required style="margin-right: 5px; resize: none;"></textarea>
            <button class="btn btn-primary" type="submit" style="background-color: #5000bf;">Enviar</button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>

        $(window).on('load', function() {
        var chatContainer = $('.container.chat');
        var chatContainerPosition = chatContainer.offset().top;

        $('html, body').scrollTop(chatContainerPosition);
        });

        $(document).ready(function() {
            var chatContainer = $('.container.chat');
            var chatMessages = $('.chat-messages');
            var isAutoScrollEnabled = true;

            // Llamar a loadMessages inicialmente
            loadMessages();

            // Función para ajustar el scroll al final del contenedor
            function scrollToBottom() {
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }

            // Actualizar los mensajes cada 5 segundos
            setInterval(loadMessages, 1000);

            // Evento de desplazamiento para controlar el scroll automático y manual
            chatMessages.on('scroll', function() {
                var scrollTop = chatMessages.scrollTop();
                var scrollHeight = chatMessages.prop('scrollHeight');
                var clientHeight = chatMessages.prop('clientHeight');
                var scrollBottom = scrollHeight - (scrollTop + clientHeight);

                // Verificar si el usuario está en la parte inferior o ha realizado un desplazamiento manual
                if (scrollBottom <= 10) {
                isAutoScrollEnabled = true;
                } else {
                isAutoScrollEnabled = false;
                }
            });

            // Función para verificar y ajustar el scroll al final cuando sea necesario
            function checkScrollPosition() {
                if (isAutoScrollEnabled) {
                scrollToBottom();
                }
            }

            // Agregar un evento después de cargar nuevos mensajes
            chatMessages.on('DOMNodeInserted', checkScrollPosition);
            });

        function loadMessages() {
        var amigoId = $('#message-form').data('amigo-id');
        var url = '/get_messages_grupo/{{ sala.id_sala }}'; // Cambia esta línea con la URL correcta

        $.ajax({
            type: 'GET',
            url: url,
            success: function(response) {
            if (response && response.messages) {
                var messagesData = response.messages;

                // Limpiar el contenido actual del contenedor de mensajes
                $('.chat-messages').empty();

                // Construir el HTML para cada mensaje
                messagesData.forEach(function(message) {
                var sender = message.remitente;
                var content = message.contenido;

                // Construir el elemento HTML del mensaje
                var messageElement = $('<div>').addClass('message');
                var messageContent = $('<div>').addClass('message-content');
                var senderParagraph = $('<p>').addClass('sender').text(sender + ':');
                var contentParagraph = $('<p>').text(content);

                // Aplicar los estilos a los elementos del mensaje
                messageElement.css({
                'align-self': 'flex-end',
                'background-color': '#dcf8c6',
                'margin-left': 'auto',
                'border-radius': '10px',
                'padding': '10px'
                }).addClass('message-sent'); // Agregar la clase 'message-sent'

                // Aplicar los estilos CSS al remitente
                senderParagraph.css({
                'font-weight': 'bold'
                });

                // Aplicar los estilos CSS al contenido
                contentParagraph.css({
                // Agrega los estilos que desees aplicar
                });

                // Agregar los elementos al contenedor del mensaje
                messageContent.append(senderParagraph, contentParagraph);
                messageElement.append(messageContent);
                $('.chat-messages').append(messageElement);

                // Agregar los elementos al contenedor del mensaje
                messageContent.append(senderParagraph, contentParagraph);
                messageElement.append(messageContent);
                $('.chat-messages').append(messageElement);
                });

                console.log(messagesData); // Imprimir los datos de los mensajes en la consola
            } else {
                console.log('No se recibieron datos válidos en la respuesta AJAX');
            }
            },
            error: function(jqXHR, textStatus, errorThrown) {
            console.log('Error en la solicitud AJAX:', textStatus, errorThrown);
            }
        });
        }
    </script>
</body>

</html>