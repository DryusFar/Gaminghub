<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

<link rel="stylesheet" href="{% static 'css/chatsala.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container chat">
        <div style="text-align: center;">
            <h2 class="fuente">{{ sala.fk_id_grupo.titulo }}</h2>
            <h5 class="fuente">( {{ sala.nombre_sala }} )</h5>
        </div>
        
        <div class="chat-messages" style="max-width: 100%; margin: 0 auto;">
            {% for chat in chat %}
            <p>{{ chat.remitente }}</p>
            <p>{{ chat.contenido }}</p>
            {% endfor %}
        </div>
        
        <!-- Aquí puedes agregar el formulario para enviar nuevos mensajes -->
        <form method="post" action="{% url 'enviarMensajeGrupo' sala_id=sala.id_sala %}" style="text-align: center;">
            {% csrf_token %}
            <input type="text" name="mensaje" placeholder="Escribe tu mensaje..." required style="display: block; margin: 0 auto;">
            <button type="submit">Enviar</button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
         $(window).on('load', function() {
        var chatContainer = $('.container.chat');
        var chatContainerPosition = chatContainer.offset().top;

        $('html, body').scrollTop(chatContainerPosition);
        });

        $(document).ready(function() {
            var chatContainer = $('.container.chat');
            var chatMessages = $('.chat-messages');
            var isAutoScrollEnabled = true;

            // Llamar a loadMessages inicialmente
            loadMessages();

            // Función para ajustar el scroll al final del contenedor
            function scrollToBottom() {
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }

            // Actualizar los mensajes cada 5 segundos
            setInterval(loadMessages, 1000);

            // Evento de desplazamiento para controlar el scroll automático y manual
            chatMessages.on('scroll', function() {
                var scrollTop = chatMessages.scrollTop();
                var scrollHeight = chatMessages.prop('scrollHeight');
                var clientHeight = chatMessages.prop('clientHeight');
                var scrollBottom = scrollHeight - (scrollTop + clientHeight);

                // Verificar si el usuario está en la parte inferior o ha realizado un desplazamiento manual
                if (scrollBottom <= 10) {
                isAutoScrollEnabled = true;
                } else {
                isAutoScrollEnabled = false;
                }
            });

            // Función para verificar y ajustar el scroll al final cuando sea necesario
            function checkScrollPosition() {
                if (isAutoScrollEnabled) {
                scrollToBottom();
                }
            }

            // Agregar un evento después de cargar nuevos mensajes
            chatMessages.on('DOMNodeInserted', checkScrollPosition);
            });
        $(document).ready(function () {
            function loadMessages() {
                $.ajax({
                    type: 'GET',
                    url: '/get_messages_grupo/{{ sala.id_sala }}',
                    success: function (response) {
                        if (response && response.messages) {
                            var messagesData = response.messages;
                            var chatMessages = $('.chat-messages');

                            // Limpiar el contenido actual del contenedor de mensajes
                            chatMessages.empty();

                            // Construir y agregar los mensajes dinámicamente
                            messagesData.forEach(function (message) {
                                var sender = message.remitente;
                                var content = message.contenido;

                                var messageElement = $('<div>');
                                var senderParagraph = $('<p>').text(sender + ':');
                                var contentParagraph = $('<p>').text(content);

                                messageElement.append(senderParagraph, contentParagraph);
                                chatMessages.append(messageElement);
                            });

                            // Hacer scroll hasta el final del contenedor de mensajes
                            chatMessages.scrollTop(chatMessages[0].scrollHeight);
                        } else {
                            console.log('No se recibieron datos válidos en la respuesta AJAX');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('Error en la solicitud AJAX:', textStatus, errorThrown);
                    }
                });
            }

            // Cargar los mensajes iniciales
            loadMessages();

            // Actualizar los mensajes cada 1 segundo
            setInterval(loadMessages, 1000);
        });
    </script>
</body>

</html>